- name: Wait for Service EXTERNAL-IP and print URL
  shell: bash
  run: |
    set -euo pipefail
    ns="${K8S_NAMESPACE}"
    svc="fighting-characters"
    echo "Waiting up to 5 minutes for LoadBalancer on Service/${svc} ..."
    for i in {1..60}; do
      host=$(kubectl -n "$ns" get svc "$svc" -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || true)
      ip=$(kubectl -n "$ns" get svc "$svc" -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
      url="${host:-$ip}"
      [ -n "$url" ] && break
      sleep 5
    done
    if [ -z "${url:-}" ]; then
      echo "::error::Service has no external address after 5m"
      kubectl -n "$ns" get svc "$svc" -o wide || true
      exit 1
    fi
    echo "App URL: http://${url}" | tee -a "$GITHUB_STEP_SUMMARY"
    if command -v curl >/dev/null 2>&1; then
      echo "Probing http://${url}/health ..."
      curl -fsS "http://${url}/health" >/dev/null && echo "Health OK" || echo "::warning::/health probe failed"
    fi
